<!DOCTYPE html>
<html>
  <head>
    <script src="jquery.js"></script>
    <script src="data_generator.js"></script>
    <link rel="stylesheet" type="text/css" href="twittler.css">
  </head>
  <body>
    <div id='navBar'>
      <button id='homeButton'>
        <img id='logo' src='logo.png'>
      </button>
    </div>
    <div class="mainContent">
      <textarea id='tweetInput' type='text'>Type tweet here.</textarea>
      <button id='post' class='feedButton'>Post</button>
      <span id='charCount'>180 characters left</span>
    </div>
    <div class="mainContent">
      <button id="refreshFeed" class='feedButton'>Refresh Feed</button>
      <div class="tweetFeed"></div>
      <button id="showMore" class='feedButton'>Show More</button>
    </div>
    <script>
      var currentStream = 'home';
      var dCount = 10;

      $(document).ready(function(){
        printStream(currentStream, dCount);

        /*Refresh current user feed every 3 minutes*/
        setInterval( function(){printStream(currentStream, dCount);}, 180000);
        
        /*Event handlers*/
        $(document).on('click', '#refreshFeed',function(){ printStream(currentStream,dCount);});
        $(document).on('click', '.tweetUsername', function(){ currentStream = $(this).text().slice(2); printStream(currentStream,dCount); });
        $(document).on('click', '#showMore',function(){ dCount += 10; printStream(currentStream, dCount); });
        $(document).on('click', '#homeButton',function(){ currentStream = 'home'; dCount=10; printStream(currentStream, dCount); });
        $(document).on('click', '#post', function(){ postTweet(); });
      });

      /*Post user's tweet*/
      var visitor = 'anonymous';
      function postTweet(){
        var msg = $('body').find('#tweetInput').val();
        if(msg){
          writeTweet(msg);
        }
      }

      /*Returns object containing units(seconds,minutes,or hours) and the time elapsed*/
      function timePassed(timestamp){
        var result = {};
        var diff = (new Date() - timestamp)/1000 // diff is in seconds
        diff > 59 ? diff/60 > 59 ?
          (result.unit='h', result.val=Math.round(diff/3600)) :
          (result.unit='m', result.val=Math.round(diff/60)) : 
          (result.unit='s', result.val=Math.round(diff));
        return result;
      }
      
      /*Appends tweets to Feed
        user - string specifies where to get tweets from
        displayCount - determines how many tweets to display */      
      function printStream(user, displayCount){
        var $tweetFeed = $('.tweetFeed')
        $tweetFeed.html(''); //Clear feed
        var index, streamPtr, count=0;
        user === 'home' ?
        (index = streams.home.length - 1, streamPtr = streams.home ) :
        (index = (streams.users)[user].length - 1, streamPtr = (streams.users)[user] ); 
        while(index >= 0 && count < displayCount){
          var tweet = streamPtr[index];
          var $tweet = $('<div class="tweet"></div>');
          var tweetAge = timePassed(tweet.created_at)
          
          $tweet.append('<img class="userIcon" src="user_icons/' + tweet.user + '.jpg">');
          $tweet.append('<span class="tweetUsername">@ ' + tweet.user + '</span>');
          $tweet.append('<span class="tweetTimestamp"> ' + tweetAge.val + ' ' + tweetAge.unit + '</span>');
          $tweet.append('<p class="tweetMsg">' + tweet.message + '</p>');

          $tweet.appendTo($tweetFeed);
          index -= 1;
          count += 1;
        }
      }

    </script>
  </body>
</html>
